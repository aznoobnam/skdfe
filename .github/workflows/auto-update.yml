name: Auto-update Soul Knight Data

on:
  schedule:
    - cron: '0 3 * * *'  # every day at 03:00 UTC

permissions:
  contents: write

jobs:
  update-data:
    runs-on: windows-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v3
      with:
        persist-credentials: true

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up .NET 6 Runtime
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: Install Python deps
      run: pip install requests

    - id: check_version
      shell: bash
      run: |
        python - << 'EOF'
        import json, requests, re, sys

        # load last version
        with open('version.json') as f:
            old = json.load(f).get('version', '')

        # fetch latest
        BASE_URL = "http://www.chillyroom.com/zh"
        APK_REGEX = re.compile(
          r"https://apk\.chillyroom\.com/apks/[\w\d.\-]+/SoulKnight-release-chillyroom-([\w\d.\-]+)\.apk"
        )
        resp = requests.get(BASE_URL, timeout=15)
        resp.raise_for_status()
        m = APK_REGEX.search(resp.text)
        if not m:
            print("::error::Could not detect latest APK version")
            sys.exit(1)
        new = m.group(1)

        # emit outputs
        print(f"old={old}")
        print(f"new={new}")
        print(f"run_update={'true' if new != old else 'false'}")
        EOF
      # Capture those prints into outputs
      env:
        GITHUB_OUTPUT: ${{ github.output }}
      # Actually set output variables
      # Note: in newer runners, you should write directly to $GITHUB_OUTPUT, 
      # but above we captured printsâ€”if you want direct, use:
      # run: |
      #   echo "old_version=$old" >> $GITHUB_OUTPUT
      #   echo "new_version=$new" >> $GITHUB_OUTPUT
      #   echo "run_update=$( [[ $new != $old ]] && echo true || echo false )" >> $GITHUB_OUTPUT

    - name: Report status
      if: always()
      run: |
        echo "Old version: ${{ steps.check_version.outputs.old }}"
        echo "New version: ${{ steps.check_version.outputs.new }}"

    - name: Stop if up to date
      if: ${{ steps.check_version.outputs.run_update == 'false' }}
      run: echo "No update needed, exiting."

    - name: Run data export
      if: ${{ steps.check_version.outputs.run_update == 'true' }}
      run: python skdata.py

    - name: Normalize output filenames
      if: ${{ steps.check_version.outputs.run_update == 'true' }}
      run: |
        mv I2language_${{ steps.check_version.outputs.new }}.csv  I2language.csv
        mv Allinfo_${{ steps.check_version.outputs.new }}.txt     Allinfo.txt

    - name: Write new version.json
      if: ${{ steps.check_version.outputs.run_update == 'true' }}
      run: |
        echo "{\"version\":\"${{ steps.check_version.outputs.new }}\"}" > version.json

    - name: Commit & push updated data
      if: ${{ steps.check_version.outputs.run_update == 'true' }}
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add I2language.csv Allinfo.txt version.json
        git commit -m "Updated to ${{ steps.check_version.outputs.new }}" || echo "Nothing to commit"
        git push
